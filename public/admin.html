<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin ¬∑ Sucursales RD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #d01c80;
      --primary-hover: #b91c7c;
      --bg: #f7f8fb;
      --panel: #ffffff;
      --line: #e5e7eb;
      --text: #0f172a;
      --muted: #64748b;
      --danger: #ef4444;
      --success: #10b981;
      --shadow: 0 4px 20px rgba(0,0,0,.08);
    }
    
    * { 
      box-sizing: border-box; 
    }
    
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: Inter, system-ui, Arial, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
    }

    .layout { 
      display: grid; 
      grid-template-columns: minmax(320px, 420px) 1fr; 
      height: 100vh; 
      overflow: hidden; 
    }

    aside { 
      background: var(--panel); 
      border-right: 1px solid var(--line); 
      display: flex; 
      flex-direction: column; 
      z-index: 1000;
      min-width: 320px;
    }

    header { 
      padding: 20px; 
      border-bottom: 1px solid var(--line); 
    }

    .brand { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
      margin-bottom: 16px;
    }

    .logo { 
      width: 40px; 
      height: 40px; 
      border-radius: 12px; 
      background: linear-gradient(135deg, var(--primary), var(--primary-hover)); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: #fff; 
      font-weight: 600; 
      box-shadow: var(--shadow);
    }

    .title { 
      font-weight: 600; 
      font-size: 18px; 
    }

    .subtitle { 
      font-size: 13px; 
      color: var(--muted); 
      margin-top: 2px; 
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 16px;
    }

    .status-active {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-inactive {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .controls { 
      display: grid; 
      gap: 12px; 
    }

    .input, .btn, .select { 
      border: 1px solid var(--line); 
      border-radius: 12px; 
      padding: 12px 14px; 
      font: inherit; 
      transition: all 0.2s ease; 
    }

    .input, .select { 
      background: #f8fafc; 
    }
    
    .input:focus, .select:focus { 
      outline: none; 
      border-color: var(--primary); 
      box-shadow: 0 0 0 3px rgba(208, 28, 128, 0.1); 
    }

    .btn { 
      background: #fff; 
      cursor: pointer; 
      font-weight: 500; 
      text-align: center;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn:hover { 
      background: #f8fafc; 
      border-color: var(--primary); 
    }

    .btn.primary { 
      background: var(--primary); 
      border-color: var(--primary); 
      color: #fff; 
      box-shadow: var(--shadow); 
    }
    
    .btn.primary:hover { 
      background: var(--primary-hover);
      transform: translateY(-1px); 
      box-shadow: 0 8px 30px rgba(208, 28, 128, 0.3); 
    }

    .btn.danger { 
      background: #fee2e2; 
      border-color: #fecaca; 
      color: #991b1b; 
    }

    .btn.danger:hover {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    .btn.success {
      background: #dcfce7;
      border-color: #bbf7d0;
      color: #166534;
    }

    .btn.success:hover {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 12px; 
    }

    .list { 
      padding: 16px; 
      overflow-y: auto; 
      overflow-x: hidden;
      display: grid; 
      gap: 12px; 
      flex: 1; 
      max-height: calc(100vh - 300px);
    }

    .list::-webkit-scrollbar {
      width: 6px;
    }

    .list::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }

    .list::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    .list::-webkit-scrollbar-thumb:hover {
      background: var(--primary-hover);
    }

    .card { 
      border: 1px solid var(--line); 
      background: #fff; 
      border-radius: 14px; 
      padding: 16px; 
      cursor: pointer; 
      transition: all 0.2s ease; 
    }
    
    .card:hover { 
      border-color: var(--primary); 
      box-shadow: var(--shadow); 
      transform: translateY(-2px); 
    }

    .card-inactive {
      opacity: 0.6;
      background: #f8fafc;
    }

    .name { 
      font-weight: 600; 
      margin-bottom: 6px; 
    }

    .muted { 
      color: var(--muted); 
      font-size: 13px; 
      margin: 2px 0; 
    }

    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .card-actions .btn {
      padding: 6px 12px;
      font-size: 12px;
      flex: 1;
      min-width: 60px;
    }

    #mapWrap { 
      position: relative; 
      overflow: hidden; 
    }

    #map { 
      height: 100vh; 
      width: 100%; 
    }

    .topbar { 
      position: absolute; 
      top: 16px; 
      left: 16px; 
      right: 16px; 
      display: flex; 
      gap: 12px; 
      z-index: 1000; 
      align-items: center; 
      flex-wrap: wrap;
    }

    .pill { 
      border: 1px solid var(--line); 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(10px); 
      padding: 10px 16px; 
      border-radius: 20px; 
      font-size: 13px; 
      font-weight: 500; 
      box-shadow: var(--shadow); 
    }

    .map-btn { 
      background: var(--primary);
      color: white; 
      border: none; 
      padding: 10px 16px; 
      border-radius: 20px; 
      cursor: pointer; 
      font-size: 13px; 
      font-weight: 500; 
      box-shadow: var(--shadow); 
      transition: all 0.2s ease; 
    }
    
    .map-btn:hover { 
      background: var(--primary-hover);
      transform: translateY(-1px); 
      box-shadow: 0 8px 30px rgba(208, 28, 128, 0.3); 
    }

    .modal { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,.4); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 2000; 
      backdrop-filter: blur(4px);
    }

    .modal-panel { 
      background: #fff; 
      border: 1px solid var(--line); 
      border-radius: 16px; 
      padding: 24px; 
      width: min(600px, 95vw); 
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title { 
      margin: 0; 
      font-size: 20px;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      padding: 4px;
    }

    .close-btn:hover {
      color: var(--text);
    }

    .form { 
      display: grid; 
      gap: 16px; 
    }

    .form-row { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 12px; 
    }

    .form-group {
      display: grid;
      gap: 6px;
    }

    .form-label {
      font-weight: 500;
      font-size: 14px;
      color: var(--text);
    }

    .form-label.required::after {
      content: " *";
      color: var(--danger);
    }

    .coordinate-helper {
      font-size: 12px;
      color: var(--muted);
      font-style: italic;
    }

    .actions { 
      display: flex; 
      gap: 12px; 
      justify-content: flex-end; 
      margin-top: 20px; 
      padding-top: 20px;
      border-top: 1px solid var(--line);
    }

    .toast { 
      position: fixed; 
      bottom: 20px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: #fff; 
      border: 1px solid var(--line); 
      padding: 12px 20px; 
      border-radius: 12px; 
      box-shadow: var(--shadow); 
      display: none; 
      z-index: 3000; 
      max-width: 400px;
    }

    .leaflet-control-zoom a {
      background-color: var(--primary) !important;
      border: 1px solid var(--primary) !important;
      color: white !important;
      font-weight: 600 !important;
      font-size: 18px !important;
      width: 30px !important;
      height: 30px !important;
      line-height: 28px !important;
      border-radius: 8px !important;
      box-shadow: var(--shadow) !important;
      transition: all 0.2s ease !important;
    }

    .leaflet-control-zoom a:hover {
      background-color: var(--primary-hover) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 8px 30px rgba(208, 28, 128, 0.3) !important;
    }

    .leaflet-control-zoom {
      border: none !important;
      box-shadow: none !important;
    }

    .map-clicking {
      cursor: crosshair !important;
    }

    .map-clicking * {
      cursor: crosshair !important;
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .layout {
        grid-template-columns: minmax(300px, 380px) 1fr;
      }
    }

    @media (max-width: 1200px) {
      .layout {
        grid-template-columns: minmax(280px, 350px) 1fr;
      }
    }

    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr;
        position: relative;
      }

      aside {
        position: absolute;
        z-index: 1200;
        left: 16px;
        top: 16px;
        right: 16px;
        height: 50%;
        width: auto;
        min-width: unset;
        border: 1px solid var(--line);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.15);
        backdrop-filter: blur(10px);
      }

      .list {
        max-height: calc(50vh - 300px);
      }

      #map {
        height: 100vh;
      }

      .topbar {
        top: auto;
        bottom: 16px;
        left: 16px;
        right: 16px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .modal-panel {
        width: min(500px, 90vw);
        margin: 20px;
      }
    }

    @media (max-width: 768px) {
      aside {
        left: 12px;
        top: 12px;
        right: 12px;
        height: 55%;
      }

      .list {
        max-height: calc(55vh - 280px);
        padding: 12px;
      }

      header {
        padding: 16px;
      }

      .topbar {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        bottom: 12px;
        left: 12px;
        right: 12px;
      }

      .pill, .map-btn {
        text-align: center;
      }

      .modal-panel {
        padding: 20px;
        width: min(450px, 95vw);
      }

      .actions {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      aside {
        height: 60%;
        left: 8px;
        top: 8px;
        right: 8px;
      }

      .list {
        max-height: calc(60vh - 260px);
        padding: 8px;
      }

      header {
        padding: 12px;
      }

      .brand {
        margin-bottom: 12px;
      }

      .logo {
        width: 36px;
        height: 36px;
      }

      .title {
        font-size: 16px;
      }

      .modal-panel {
        padding: 16px;
        width: calc(100vw - 20px);
        margin: 10px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-title {
        font-size: 18px;
      }

      .topbar {
        bottom: 8px;
        left: 8px;
        right: 8px;
      }

      .card {
        padding: 12px;
      }

      .card-actions {
        margin-top: 8px;
      }

      .card-actions .btn {
        padding: 4px 8px;
        font-size: 11px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 360px) {
      aside {
        height: 65%;
        left: 4px;
        top: 4px;
        right: 4px;
      }

      .list {
        max-height: calc(65vh - 240px);
      }

      .modal-panel {
        width: calc(100vw - 10px);
        margin: 5px;
        padding: 12px;
      }

      header {
        padding: 8px;
      }

      .controls {
        gap: 8px;
      }

      .input, .btn, .select {
        padding: 8px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside>
      <header>
        <div class="brand">
          <div class="logo">RD</div>
          <div>
            <div class="title">Admin ¬∑ Sucursales</div>
            <div class="subtitle">Rep√∫blica Dominicana</div>
          </div>
        </div>

        <div id="adminStatus" class="status-indicator status-inactive">
          <span>üîí</span>
          <span>Modo Admin: Desactivado</span>
        </div>

        <div class="controls">
          <input id="search" class="input" placeholder="Buscar (nombre, direcci√≥n, provincia)..." />
          
          <div class="grid">
            <button id="createBtn" class="btn primary">+ Nueva Sucursal</button>
            <a class="btn" href="./">Ver Mapa P√∫blico</a>
          </div>

          <input id="adminSecret" class="input" placeholder="Contrase√±a de administrador" type="password" />
          <button id="saveSecret" class="btn success">Activar Modo Admin</button>
        </div>
      </header>
      <div id="list" class="list"></div>
    </aside>

    <div id="mapWrap">
      <div class="topbar">
        <span id="status" class="pill">Cargando‚Ä¶</span>
        <button id="refresh" class="map-btn">üîÑ Refrescar</button>
        <button id="toggleLocation" class="map-btn" style="display: none;">üìç Seleccionar Ubicaci√≥n</button>
      </div>
      <div id="map"></div>
    </div>
  </div>

  <!-- Modal Crear/Editar -->
  <div id="modal" class="modal">
    <div class="modal-panel">
      <div class="modal-header">
        <h3 id="modalTitle" class="modal-title">Nueva Sucursal</h3>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      
      <div class="form">
        <input id="f_id" type="hidden" />
        
        <div class="form-group">
          <label class="form-label required">Nombre de la Sucursal</label>
          <input id="f_name" class="input" placeholder="Ej: Sucursal Centro, Oficina Principal..." />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label required">Provincia</label>
            <select id="f_province" class="select">
              <option value="">Seleccionar provincia...</option>
              <option value="Distrito Nacional">Distrito Nacional</option>
              <option value="Santiago">Santiago</option>
              <option value="La Altagracia">La Altagracia</option>
              <option value="Puerto Plata">Puerto Plata</option>
              <option value="La Romana">La Romana</option>
              <option value="San Pedro de Macor√≠s">San Pedro de Macor√≠s</option>
              <option value="Duarte">Duarte</option>
              <option value="La Vega">La Vega</option>
              <option value="Espaillat">Espaillat</option>
              <option value="Monte Cristi">Monte Cristi</option>
              <option value="Valverde">Valverde</option>
              <option value="Santiago Rodr√≠guez">Santiago Rodr√≠guez</option>
              <option value="Dajab√≥n">Dajab√≥n</option>
              <option value="Monse√±or Nouel">Monse√±or Nouel</option>
              <option value="S√°nchez Ram√≠rez">S√°nchez Ram√≠rez</option>
              <option value="Hermanas Mirabal">Hermanas Mirabal</option>
              <option value="Saman√°">Saman√°</option>
              <option value="Mar√≠a Trinidad S√°nchez">Mar√≠a Trinidad S√°nchez</option>
              <option value="San Crist√≥bal">San Crist√≥bal</option>
              <option value="Monte Plata">Monte Plata</option>
              <option value="Hato Mayor">Hato Mayor</option>
              <option value="El Seibo">El Seibo</option>
              <option value="San Jos√© de Ocoa">San Jos√© de Ocoa</option>
              <option value="Peravia">Peravia</option>
              <option value="Azua">Azua</option>
              <option value="San Juan">San Juan</option>
              <option value="El√≠as Pi√±a">El√≠as Pi√±a</option>
              <option value="Baoruco">Baoruco</option>
              <option value="Barahona">Barahona</option>
              <option value="Independencia">Independencia</option>
              <option value="Pedernales">Pedernales</option>
              <option value="Santo Domingo">Santo Domingo</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Municipio</label>
            <input id="f_municipality" class="input" placeholder="Ej: Santiago de los Caballeros..." />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label required">Direcci√≥n Completa</label>
          <input id="f_address" class="input" placeholder="Ej: Av. 27 de Febrero #123, Plaza Central..." />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label required">Coordenadas - Latitud</label>
            <input id="f_lat" class="input" placeholder="Ej: 19.4517" type="number" step="any" />
            <div class="coordinate-helper">üí° Haz clic en el mapa para seleccionar ubicaci√≥n</div>
          </div>

          <div class="form-group">
            <label class="form-label required">Coordenadas - Longitud</label>
            <input id="f_lng" class="input" placeholder="Ej: -70.6969" type="number" step="any" />
            <div class="coordinate-helper">üí° O ingresa las coordenadas manualmente</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Tel√©fono</label>
            <input id="f_phone" class="input" placeholder="Ej: (809) 123-4567" />
          </div>

          <div class="form-group">
            <label class="form-label">Horario</label>
            <select id="f_hours" class="select">
              <option value="">Seleccionar horario...</option>
              <option value="24 horas">24 horas</option>
              <option value="Lun-Vie 8:00AM-5:00PM">Lun-Vie 8:00AM-5:00PM</option>
              <option value="Lun-Vie 9:00AM-6:00PM">Lun-Vie 9:00AM-6:00PM</option>
              <option value="Lun-S√°b 8:00AM-6:00PM">Lun-S√°b 8:00AM-6:00PM</option>
              <option value="Lun-S√°b 9:00AM-7:00PM">Lun-S√°b 9:00AM-7:00PM</option>
              <option value="Lun-Dom 8:00AM-8:00PM">Lun-Dom 8:00AM-8:00PM</option>
              <option value="Lun-Dom 9:00AM-9:00PM">Lun-Dom 9:00AM-9:00PM</option>
              <option value="Personalizado">Personalizado...</option>
            </select>
            <input id="f_hours_custom" class="input" placeholder="Ingresa horario personalizado..." style="display: none; margin-top: 8px;" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Estado</label>
          <select id="f_active" class="select">
            <option value="true">Activa</option>
            <option value="false">Inactiva</option>
          </select>
        </div>

        <div class="actions">
          <button id="cancel" class="btn">Cancelar</button>
          <button id="save" class="btn primary">Guardar Sucursal</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Config
    const MAP_CENTER = [18.9, -70.3];
    const MAP_ZOOM = 8;
    const BASE_API = "/api/branches";

    // State
    let ADMIN_SECRET = localStorage.getItem('rd_admin_secret') || "";
    let rows = [];
    let markers = [];
    let editing = null;
    let isSelectingLocation = false;
    let tempMarker = null;

    // DOM Elements
    const $ = id => document.getElementById(id);
    const status = $('status');
    const toast = $('toast');
    const modal = $('modal');
    const title = $('modalTitle');
    const adminStatus = $('adminStatus');
    const toggleLocationBtn = $('toggleLocation');

    // Form fields
    const f_id = $('f_id');
    const f_name = $('f_name');
    const f_province = $('f_province');
    const f_municipality = $('f_municipality');
    const f_address = $('f_address');
    const f_lat = $('f_lat');
    const f_lng = $('f_lng');
    const f_phone = $('f_phone');
    const f_hours = $('f_hours');
    const f_hours_custom = $('f_hours_custom');
    const f_active = $('f_active');

    // Initialize
    $('adminSecret').value = ADMIN_SECRET;
    updateAdminStatus();

    // Helper functions
    const showToast = (text) => {
      toast.textContent = text;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    };

    const esc = s => (''+s).replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[m]));

    function updateAdminStatus() {
      if (ADMIN_SECRET) {
        adminStatus.className = 'status-indicator status-active';
        adminStatus.innerHTML = '<span>üîì</span><span>Modo Admin: Activado</span>';
        $('saveSecret').textContent = 'Cambiar Contrase√±a';
        $('saveSecret').className = 'btn';
      } else {
        adminStatus.className = 'status-indicator status-inactive';
        adminStatus.innerHTML = '<span>üîí</span><span>Modo Admin: Desactivado</span>';
        $('saveSecret').textContent = 'Activar Modo Admin';
        $('saveSecret').className = 'btn success';
      }
    }

    async function validateAdminSecret(secret) {
      if (!secret.trim()) return false;
      
      try {
        const testResponse = await fetch(BASE_API, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'x-admin-secret': secret 
          },
          body: JSON.stringify({ 
            test_validation: true,
            name: "test",
            province: "test",
            address: "test",
            lat: 0,
            lng: 0
          })
        });
        
        return testResponse.status !== 401 && testResponse.status !== 403;
      } catch (error) {
        console.error('Error validating admin secret:', error);
        return true;
      }
    }

    // Map setup
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: true
    }).setView(MAP_CENTER, MAP_ZOOM);


    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: ['a','b','c','d'],
      maxZoom: 20
    }).addTo(map);

    const layer = L.layerGroup().addTo(map);

    // Map click handler
    map.on('click', function(e) {
      if (modal.style.display === 'flex' || isSelectingLocation) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        f_lat.value = lat;
        f_lng.value = lng;
        
        if (tempMarker) {
          map.removeLayer(tempMarker);
        }
        
        const customIcon = L.divIcon({
          html: '<div style="background: #d01c80; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(208, 28, 128, 0.4); border: 3px solid white;">üìç</div>',
          className: 'temp-marker',
          iconSize: [38, 38],
          iconAnchor: [19, 19]
        });
        
        tempMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
        tempMarker.bindPopup('<div style="text-align: center; font-family: Inter, sans-serif;"><strong style="color: #d01c80;">üìç Nueva ubicaci√≥n</strong><br/>Lat: ' + lat + '<br/>Lng: ' + lng + '</div>').openPopup();
        
        if (isSelectingLocation) {
          setTimeout(() => {
            toggleLocationSelection();
          }, 1500);
        }
        
        if (modal.style.display !== 'flex') {
          setTimeout(() => {
            modal.style.display = 'flex';
          }, 500);
        }
        
        showToast('üìç Ubicaci√≥n seleccionada: ' + lat + ', ' + lng);
      }
    });

    // Data functions
    async function fetchAll() {
      try {
        status.textContent = 'Cargando‚Ä¶';
        const r = await fetch(BASE_API, {cache:'no-store'});
        rows = r.ok ? await r.json() : [];
        status.textContent = rows.length + ' sucursal' + (rows.length === 1 ? '' : 'es');
        showToast('Datos cargados correctamente');
      } catch (error) {
        console.error('Error cargando datos:', error);
        showToast('‚ùå Error al cargar los datos');
        rows = [];
        status.textContent = '0 sucursales';
      }
    }

    function draw(list = rows) {
      layer.clearLayers();
      markers = [];
      
      $('list').innerHTML = list.length ? list.map((b,i) => {
        const isActive = b.is_active !== false;
        return '<div class="card ' + (isActive ? '' : 'card-inactive') + '" data-i="' + i + '">' +
          '<div class="name">' + esc(b.name || '') + '</div>' +
          '<div class="muted">üìç ' + esc(b.address || '') + '</div>' +
          '<div class="muted">üèõÔ∏è ' + esc(b.province || '') + (b.municipality ? ', ' + esc(b.municipality) : '') + '</div>' +
          (b.phone ? '<div class="muted">üìû ' + esc(b.phone) + '</div>' : '') +
          (b.hours ? '<div class="muted">üïí ' + esc(b.hours) + '</div>' : '') +
          '<div class="muted">üìä ' + (isActive ? 'Activa' : 'Inactiva') + '</div>' +
          '<div class="card-actions">' +
            '<button class="btn" data-edit="' + i + '">Editar</button>' +
            '<button class="btn ' + (isActive ? 'danger' : 'success') + '" data-toggle="' + i + '">' + (isActive ? 'Desactivar' : 'Activar') + '</button>' +
            '<button class="btn danger" data-del="' + i + '">Eliminar</button>' +
          '</div>' +
        '</div>';
      }).join('') : '<div style="text-align: center; color: var(--muted); padding: 40px 20px;">No se encontraron sucursales</div>';

      $('list').onclick = (ev) => {
        const editBtn = ev.target.closest('[data-edit]');
        const toggleBtn = ev.target.closest('[data-toggle]');
        const delBtn = ev.target.closest('[data-del]');
        const card = ev.target.closest('.card');
        
        if (editBtn) { 
          openEdit(+editBtn.getAttribute('data-edit'), list); 
          return; 
        }
        if (toggleBtn) { 
          toggleActive(+toggleBtn.getAttribute('data-toggle'), list); 
          return; 
        }
        if (delBtn) {  
          doDelete(+delBtn.getAttribute('data-del'), list); 
          return; 
        }
        if (card) { 
          const i = +card.getAttribute('data-i'); 
          const b = list[i]; 
          if (b) {
            map.flyTo([+b.lat, +b.lng], 15, {duration: 1});
            setTimeout(() => {
              markers.forEach(marker => {
                const markerLatLng = marker.getLatLng();
                if (Math.abs(markerLatLng.lat - b.lat) < 0.0001 && Math.abs(markerLatLng.lng - b.lng) < 0.0001) {
                  marker.openPopup();
                }
              });
            }, 1000);
          }
        }
      };

      list.forEach((b, i) => {
        const isActive = b.is_active !== false;
        const customIcon = L.divIcon({
          html: '<div style="background: ' + (isActive ? '#d01c80' : '#64748b') + '; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 3px solid white; opacity: ' + (isActive ? 1 : 0.7) + ';">üìç</div>',
          className: 'custom-marker',
          iconSize: [34, 34],
          iconAnchor: [17, 17]
        });

        const marker = L.marker([+b.lat, +b.lng], { icon: customIcon }).addTo(layer);
        marker.bindPopup(
          '<div style="min-width: 280px; font-family: Inter, system-ui, sans-serif;">' +
            '<div style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: #0f172a;">' + esc(b.name || '') + '</div>' +
            '<div style="color: #64748b; margin-bottom: 8px; font-size: 14px;">üìç ' + esc(b.address || '') + '</div>' +
            '<div style="color: #64748b; font-size: 12px; margin-bottom: 8px;">üèõÔ∏è ' + esc(b.province || '') + (b.municipality ? ', ' + esc(b.municipality) : '') + '</div>' +
            (b.phone ? '<div style="color: #64748b; font-size: 12px; margin-bottom: 4px;">üìû ' + esc(b.phone) + '</div>' : '') +
            (b.hours ? '<div style="color: #64748b; font-size: 12px; margin-bottom: 8px;">üïí ' + esc(b.hours) + '</div>' : '') +
            '<div style="color: #64748b; font-size: 12px; margin-bottom: 12px;">üìä ' + (isActive ? 'Activa' : 'Inactiva') + ' ¬∑ ' + (+b.lat).toFixed(5) + ', ' + (+b.lng).toFixed(5) + '</div>' +
            '<div style="display: flex; gap: 8px; margin-top: 12px;">' +
              '<button onclick="openEdit(' + i + ')" style="flex: 1; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 12px;">Editar</button>' +
              '<button onclick="toggleActive(' + i + ')" style="flex: 1; padding: 8px 12px; border: 1px solid ' + (isActive ? '#fecaca' : '#bbf7d0') + '; border-radius: 8px; background: ' + (isActive ? '#fee2e2' : '#dcfce7') + '; color: ' + (isActive ? '#991b1b' : '#166534') + '; cursor: pointer; font-size: 12px;">' + (isActive ? 'Desactivar' : 'Activar') + '</button>' +
            '</div>' +
          '</div>', 
          { maxWidth: 320, className: 'custom-popup-container' }
        );
        markers.push(marker);
      });

      if (list.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.05));
      }
    }

    // Global functions
    window.openEdit = (i, list = rows) => { 
      const b = list[i]; 
      if (!b) return; 
      openModal(b); 
    };

    window.toggleActive = async (i, list = rows) => {
      const b = list[i]; 
      if (!b) return;
      if (!ADMIN_SECRET) { 
        alert('‚ùå Necesitas activar el modo admin primero'); 
        return; 
      }
      
      const newStatus = !b.is_active;
      const action = newStatus ? 'activar' : 'desactivar';
      
      if (!confirm('¬øEst√°s seguro de ' + action + ' esta sucursal?')) return;
      
      try {
        const r = await fetch(BASE_API + '?id=' + encodeURIComponent(b.id), { 
          method: 'PUT', 
          headers: { 
            'Content-Type': 'application/json',
            'x-admin-secret': ADMIN_SECRET 
          },
          body: JSON.stringify(Object.assign({}, b, { is_active: newStatus }))
        });
        
        if (!r.ok) {
          showToast('‚ùå Error al cambiar estado');
          return;
        }
        
        await fetchAll(); 
        draw(); 
        showToast('‚úÖ Sucursal ' + action + 'da correctamente');
      } catch (error) {
        console.error('Error:', error);
        showToast('‚ùå Error de conexi√≥n');
      }
    };

    window.doDelete = async (i, list = rows) => {
      const b = list[i]; 
      if (!b) return;
      if (!ADMIN_SECRET) { 
        alert('‚ùå Necesitas activar el modo admin primero'); 
        return; 
      }
      
      if (!confirm('¬øEst√°s seguro de eliminar "' + b.name + '"?\n\nEsta acci√≥n no se puede deshacer.')) return;
      
      try {
        const r = await fetch(BASE_API + '?id=' + encodeURIComponent(b.id), { 
          method: 'DELETE', 
          headers: { 'x-admin-secret': ADMIN_SECRET }
        });
        
        if (!r.ok) {
          showToast('‚ùå Error al eliminar sucursal');
          return;
        }
        
        await fetchAll(); 
        draw(); 
        showToast('üóëÔ∏è Sucursal eliminada');
      } catch (error) {
        console.error('Error:', error);
        showToast('‚ùå Error de conexi√≥n');
      }
    };

    // Hours dropdown handler
    f_hours.addEventListener('change', () => {
      if (f_hours.value === 'Personalizado') {
        f_hours_custom.style.display = 'block';
        f_hours_custom.focus();
      } else {
        f_hours_custom.style.display = 'none';
        f_hours_custom.value = '';
      }
    });

    // Search
    $('search').addEventListener('input', () => {
      const q = $('search').value.trim().toLowerCase();
      if (!q) return draw(rows);
      
      const list = rows.filter(b =>
        (b.name || '').toLowerCase().includes(q) ||
        (b.address || '').toLowerCase().includes(q) ||
        (b.province || '').toLowerCase().includes(q) ||
        (b.municipality || '').toLowerCase().includes(q) ||
        (b.phone || '').toLowerCase().includes(q)
      );
      draw(list);
    });

    // Admin Secret
    $('saveSecret').onclick = async () => { 
      const newSecret = $('adminSecret').value.trim();
      
      if (!newSecret) {
        ADMIN_SECRET = '';
        localStorage.removeItem('rd_admin_secret');
        updateAdminStatus();
        showToast('üîí Modo admin desactivado');
        return;
      }
      
      const originalText = $('saveSecret').textContent;
      $('saveSecret').textContent = 'Validando...';
      $('saveSecret').disabled = true;
      
      const isValid = await validateAdminSecret(newSecret);
      
      $('saveSecret').textContent = originalText;
      $('saveSecret').disabled = false;
      
      if (isValid) {
        ADMIN_SECRET = newSecret;
        localStorage.setItem('rd_admin_secret', ADMIN_SECRET);
        updateAdminStatus();
        showToast('‚úÖ Modo admin activado correctamente');
      } else {
        // Reset to empty and update status to show as inactive
        ADMIN_SECRET = '';
        localStorage.removeItem('rd_admin_secret');
        $('adminSecret').value = '';
        updateAdminStatus();
        showToast('‚ùå Contrase√±a incorrecta. Modo admin desactivado.');
      }
    };

    // Create
    $('createBtn').onclick = () => {
      if (!ADMIN_SECRET) {
        alert('‚ùå Necesitas activar el modo admin primero');
        return;
      }
      openModal();
    };

    // Refresh
    $('refresh').onclick = async () => { 
      await fetchAll(); 
      draw(); 
    };

    // Location Selection
    function toggleLocationSelection() {
      isSelectingLocation = !isSelectingLocation;
      
      if (isSelectingLocation) {
        map.getContainer().classList.add('map-clicking');
        toggleLocationBtn.textContent = '‚ùå Cancelar Selecci√≥n';
        toggleLocationBtn.style.background = '#ef4444';
        toggleLocationBtn.style.borderColor = '#ef4444';
        showToast('üéØ Haz clic en el mapa para seleccionar la ubicaci√≥n exacta');
      } else {
        map.getContainer().classList.remove('map-clicking');
        toggleLocationBtn.textContent = 'üìç Seleccionar Ubicaci√≥n';
        toggleLocationBtn.style.background = '';
        toggleLocationBtn.style.borderColor = '';
      }
    }

    toggleLocationBtn.onclick = toggleLocationSelection;

    // Modal functions
    function openModal(branch = null) {
      editing = branch;
      title.textContent = branch ? 'Editar Sucursal' : 'Nueva Sucursal';
      
      f_id.value = branch ? branch.id || '' : '';
      f_name.value = branch ? branch.name || '' : '';
      f_province.value = branch ? branch.province || '' : '';
      f_municipality.value = branch ? branch.municipality || '' : '';
      f_address.value = branch ? branch.address || '' : '';
      f_lat.value = branch ? (branch.lat !== undefined ? branch.lat : '') : '';
      f_lng.value = branch ? (branch.lng !== undefined ? branch.lng : '') : '';
      f_phone.value = branch ? branch.phone || '' : '';
      
      const hoursValue = branch ? branch.hours || '' : '';
      f_hours_custom.style.display = 'none';
      f_hours_custom.value = '';
      
      const hoursFound = Array.from(f_hours.options).some(option => option.value === hoursValue);
      if (hoursFound) {
        f_hours.value = hoursValue;
      } else if (hoursValue) {
        f_hours.value = 'Personalizado';
        f_hours_custom.style.display = 'block';
        f_hours_custom.value = hoursValue;
      } else {
        f_hours.value = '';
      }
      
      f_active.value = branch && branch.is_active === false ? 'false' : 'true';
      
      toggleLocationBtn.style.display = 'block';
      
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
      
      modal.style.display = 'flex';
      f_name.focus();
    }

    function closeModal() { 
      modal.style.display = 'none'; 
      toggleLocationBtn.style.display = 'none';
      
      if (isSelectingLocation) {
        toggleLocationSelection();
      }
      
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
    }

    window.closeModal = closeModal;

    $('cancel').onclick = closeModal;
    modal.addEventListener('click', (e) => { 
      if (e.target === modal) closeModal(); 
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeModal();
      }
    });

    // Save
    $('save').onclick = async () => {
      if (!ADMIN_SECRET) { 
        alert('‚ùå Necesitas activar el modo admin primero'); 
        return; 
      }
      
      let hoursValue = f_hours.value;
      if (hoursValue === 'Personalizado') {
        hoursValue = f_hours_custom.value.trim();
      }
      
      const payload = {
        name: f_name.value.trim(),
        province: f_province.value.trim(),
        municipality: f_municipality.value.trim() || null,
        address: f_address.value.trim(),
        lat: parseFloat(f_lat.value),
        lng: parseFloat(f_lng.value),
        phone: f_phone.value.trim() || null,
        hours: hoursValue || null,
        is_active: f_active.value === 'true'
      };
      
      if (!payload.name || !payload.province || !payload.address || 
          Number.isNaN(payload.lat) || Number.isNaN(payload.lng)) {
        alert('‚ùå Por favor completa todos los campos obligatorios (marcados con *)');
        return;
      }
      
      if (payload.lat < 17.5 || payload.lat > 20.0 || payload.lng < -72.5 || payload.lng > -68.0) {
        if (!confirm('‚ö†Ô∏è Las coordenadas parecen estar fuera de Rep√∫blica Dominicana.\n¬øEst√°s seguro de continuar?')) {
          return;
        }
      }
      
      const saveBtn = $('save');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'Guardando...';
      saveBtn.disabled = true;
      
      try {
        let resp;
        if (editing && f_id.value) {
          resp = await fetch(BASE_API + '?id=' + encodeURIComponent(f_id.value), {
            method: 'PUT',
            headers: { 
              'Content-Type': 'application/json', 
              'x-admin-secret': ADMIN_SECRET 
            },
            body: JSON.stringify(payload)
          });
        } else {
          resp = await fetch(BASE_API, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json', 
              'x-admin-secret': ADMIN_SECRET 
            },
            body: JSON.stringify(payload)
          });
        }
        
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
        
        if (!resp.ok) { 
          const errorText = await resp.text();
          console.error('Server error:', errorText);
          showToast('‚ùå Error al guardar: ' + (errorText || 'Error desconocido')); 
          return; 
        }
        
        closeModal();
        await fetchAll(); 
        draw();
        showToast('‚úÖ Sucursal guardada correctamente');
        
        if (!editing && payload.lat && payload.lng) {
          setTimeout(() => {
            map.flyTo([payload.lat, payload.lng], 15, {duration: 1});
          }, 500);
        }
        
      } catch (error) {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
        
        console.error('Error:', error);
        showToast('‚ùå Error de conexi√≥n: ' + error.message);
      }
    };

    // Initialize
    fetchAll().then(() => {
      draw();
    });

    // Responsive
    window.addEventListener('resize', () => {
      setTimeout(() => map.invalidateSize(), 100);
    });
  </script>
</body>
</html>