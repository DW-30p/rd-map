<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa RD ¬∑ Sucursales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #d01c80;
      --primary-hover: #b91c7c;
      --bg: #f7f8fb;
      --panel: #ffffff;
      --line: #e5e7eb;
      --text: #0f172a;
      --muted: #64748b;
      --shadow: 0 4px 20px rgba(0,0,0,.08);
    }
    
    * { box-sizing: border-box; }
    
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: Inter, system-ui, Arial, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
    }

    #map { 
      height: 100vh; 
      width: 100%; 
    }

    .topbar { 
      position: absolute; 
      top: 16px; 
      left: 16px; 
      right: 16px; 
      display: flex; 
      gap: 12px; 
      z-index: 1000; 
      align-items: center; 
    }

    .pill { 
      border: 1px solid var(--line); 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(10px); 
      padding: 10px 16px; 
      border-radius: 20px; 
      font-size: 13px; 
      font-weight: 500; 
      box-shadow: var(--shadow); 
    }

    .refresh-btn { 
      background: var(--primary);
      color: white; 
      border: none; 
      padding: 10px 16px; 
      border-radius: 20px; 
      cursor: pointer; 
      font-size: 13px; 
      font-weight: 500; 
      box-shadow: var(--shadow); 
      transition: all 0.2s ease; 
    }
    
    .refresh-btn:hover { 
      background: var(--primary-hover);
      transform: translateY(-1px); 
      box-shadow: 0 8px 30px rgba(208, 28, 128, 0.3); 
    }

    .toast { 
      position: fixed; 
      bottom: 20px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: #fff; 
      border: 1px solid var(--line); 
      padding: 12px 20px; 
      border-radius: 12px; 
      box-shadow: var(--shadow); 
      display: none; 
      z-index: 2000; 
    }

    /* Personalizar controles de zoom (flechitas) */
    .leaflet-control-zoom a {
      background-color: var(--primary) !important;
      border: 1px solid var(--primary) !important;
      color: white !important;
      font-weight: 600 !important;
      font-size: 18px !important;
      width: 30px !important;
      height: 30px !important;
      line-height: 28px !important;
      border-radius: 8px !important;
      box-shadow: var(--shadow) !important;
      transition: all 0.2s ease !important;
    }

    .leaflet-control-zoom a:hover {
      background-color: var(--primary-hover) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 8px 30px rgba(208, 28, 128, 0.3) !important;
    }

    .leaflet-control-zoom {
      border: none !important;
      box-shadow: none !important;
    }

    /* Estilos para popup personalizado */
    .custom-popup {
      min-width: 250px;
      font-family: Inter, system-ui, Arial, sans-serif;
    }

    .popup-header {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--text);
    }

    .popup-address {
      color: var(--muted);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .popup-coords {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 12px;
    }

    .popup-actions {
      display: flex;
      gap: 12px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: white;
      color: var(--text);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
      flex: 1;
      justify-content: center;
    }

    .action-btn:hover {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(208, 28, 128, 0.3);
    }

    .action-btn img {
      width: 18px;
      height: 18px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .topbar {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .pill, .refresh-btn {
        text-align: center;
      }

      .popup-actions {
        flex-direction: column;
      }

      .action-btn {
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .topbar {
        left: 12px;
        right: 12px;
        top: 12px;
      }

      .leaflet-control-zoom {
        position: absolute !important;
        right: 12px !important;
        bottom: 80px !important;
        top: auto !important;
        left: auto !important;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <span id="badge" class="pill">Cargando‚Ä¶</span>
    <button id="refresh" class="refresh-btn">üîÑ Refrescar</button>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // === Config ===
    const MAPTILER_KEY = ""; // Puedes obtener una clave gratuita en maptiler.com
    const BASE_API = "/api/branches";

    // === Helpers ===
    const $ = id => document.getElementById(id);
    const badge = $('badge');
    const toast = $('toast');
    const showToast = (t) => { 
      toast.textContent = t; 
      toast.style.display = 'block'; 
      setTimeout(() => toast.style.display = 'none', 3000); 
    };
    const esc = s => (''+s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    // === Mapa ===
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: true
    }).setView([18.9, -70.3], 8);

    // Mejor calidad de mapa
    if (MAPTILER_KEY) {
      L.tileLayer(`https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.jpg?key=${MAPTILER_KEY}`, {
        attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 20
      }).addTo(map);
    } else {
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: ['a','b','c','d'],
        maxZoom: 20
      }).addTo(map);
    }

    // Cluster personalizado
    const cluster = L.markerClusterGroup({
      showCoverageOnHover: false,
      maxClusterRadius: 50,
      iconCreateFunction: function(cluster) {
        const count = cluster.getChildCount();
        return new L.DivIcon({
          html: `<div style="background: #d01c80; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 600; box-shadow: 0 4px 12px rgba(208, 28, 128, 0.4); border: 3px solid white;"><span>${count}</span></div>`,
          className: 'custom-cluster',
          iconSize: new L.Point(40, 40)
        });
      }
    });
    map.addLayer(cluster);

    let data = [];

    async function loadData() {
      try {
        badge.textContent = 'Cargando‚Ä¶';
        const r = await fetch(BASE_API, {cache:'no-store'});
        data = r.ok ? await r.json() : [];
        badge.textContent = `${data.length} sucursal${data.length===1?'':'es'}`;
        showToast('Datos cargados correctamente');
      } catch (error) {
        console.error('Error cargando datos:', error);
        showToast('Error al cargar los datos');
        data = [];
        badge.textContent = '0 sucursales';
      }
    }

    function createCustomPopup(branch) {
      return `
        <div class="custom-popup">
          <div class="popup-header">${esc(branch.name || '')}</div>
          <div class="popup-address">üìç ${esc(branch.address || '')}</div>
          <div class="popup-coords">üèõÔ∏è ${esc(branch.province || '')} ¬∑ ${(+branch.lat).toFixed(5)}, ${(+branch.lng).toFixed(5)}</div>
          <div class="popup-actions">
            <a href="https://www.google.com/maps/dir/?api=1&destination=${branch.lat},${branch.lng}" 
               target="_blank" 
               class="action-btn">
              <img src="./public/icons/maps.png" alt="Google Maps" onerror="this.style.display='none'">
              <span>Google Maps</span>
            </a>
            <a href="https://waze.com/ul?ll=${branch.lat},${branch.lng}&navigate=yes" 
               target="_blank" 
               class="action-btn">
              <img src="./public/icons/waze.png" alt="Waze" onerror="this.style.display='none'">
              <span>Waze</span>
            </a>
          </div>
        </div>
      `;
    }

    function draw() {
      cluster.clearLayers();
      const markers = [];

      // Crear marcadores
      data.forEach(b => {
        const customIcon = L.divIcon({
          html: `<div style="background: #d01c80; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(208, 28, 128, 0.4); border: 3px solid white;">üìç</div>`,
          className: 'custom-marker',
          iconSize: [34, 34],
          iconAnchor: [17, 17]
        });

        const marker = L.marker([+b.lat, +b.lng], { icon: customIcon });
        marker.bindPopup(createCustomPopup(b), {
          maxWidth: 300,
          className: 'custom-popup-container'
        });
        markers.push(marker);
      });
      
      cluster.addLayers(markers);

      // Ajustar vista si hay datos
      if (data.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.05));
      }
    }

    // Event listeners
    $('refresh').addEventListener('click', async () => {
      await loadData();
      draw();
    });

    // Inicializaci√≥n
    (async function boot() {
      await loadData();
      draw();
    })();

    // Ajustar mapa en resize
    window.addEventListener('resize', () => {
      setTimeout(() => map.invalidateSize(), 100);
    });
  </script>
</body>
</html>